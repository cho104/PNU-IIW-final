<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <!-- 첫 번째 드롭다운 -->
  <label for="firstSelect">시/도:</label>
  <select id="firstSelect" onchange="updateSecondSelect()">
    <option value="">-- 선택하세요 --</option>
    <option value="a">서울</option>
    <option value="b">부산</option>
    <option value="c">C</option>
  </select>

  <!-- 두 번째 드롭다운 (시도 하위 선택지)-->
  <label for="secondSelect">시군구:</label>
  <select id="secondSelect" onchange="generateURL()">
    <option value="">-- 시/도를 선택하세요 --</option>
  </select>

  <!-- 세 번째 드롭다운 (성별) -->
  <label for="thirdSelect">성별:</label>
  <select id="thirdSelect" onchange="generateURL()">
    <option value="">-- 선택하세요 --</option>
    <option value="x">남</option>
    <option value="y">여</option>
    <option value="z">모름</option>  <!--모름 선택시 암수 모두 뜨도록 함-->
  </select>
 
  <!-- 네 번째 드롭다운 (동물 종류) -->
   <label for="forthSelect">종:</label>
  <select id="forthSelect" onchange="generateURL()">
    <option value="">-- 선택하세요 --</option>
    <option value="dog">개</option>
    <option value="cat">고양이</option>
    <option value="etc">기타</option>
  </select>

  <!-- 서버 전송 버튼 -->
  <button onclick="sendToServer()">확인</button>

  <hr>
  <!-- 검색 결과-->
   <div id="result"></div>

  <script>
    // 숫자 코드 매핑
    const codeMap = {
      a: 6110000,
      b: 6410000,
      c: 6280000,

      // 서울시 구 코드
      '강북구': 3080000,
      '강남구': 3220000,
      '강동구': 3240000,
      '관악구':3200000,
      '광진구': 3040000,
      '구로구': 3160000,
      '금천구': 3170000,
      '노원구': 3100000,
      '도봉구': 3090000,
      '동대문구': 3050000,
      '동작구': 3190000,
      '마포구': 3130000,
      '서대문구':3120000,
      '서초구': 3210000,
      '성동구': 3030000,
      '성북구': 3070000,
      '송파구': 3230000,
      '양천구': 3140000,
      '영등포구': 3180000,
      '용산구': 3020000,
      '은평구': 3110000,
      '종로구': 3000000,
      '중구': 3010000,
      '중랑구': 3060000,

      // 부산시 구 코드

      
      // 성별 코드
      x: 'M',
      y: 'F',
      z: 'Q',
      'dog': 417000,
      'cat': 422400, 
      'etc' : 429900
    };

    const subOptions = {
      a: ['강북구', '강남구', '강동구', '관악구', '광진구', '구로구', '금천구', '노원구', '도봉구', '동대문구', '동작구', '마포구', '서대문구', '서초구', '성동구', '성북구', '송파구', '양천구', '영등포구', '용산구', '은평구', '종로구', '중구', '중랑구'],
      b: [],
      c: []
    };

    let generatedUrl = "";

    function updateSecondSelect() {
      const first = $("#firstSelect").val();
      const secondSelect = $("#secondSelect");
      secondSelect.empty();

      if (first && subOptions[first]) {
        subOptions[first].forEach(option => {
          secondSelect.append(
            $("<option>").val(option).text(option)
          );
        });
      } else {
        secondSelect.append($("<option>").val("").text("-- 먼저 첫 번째를 선택하세요 --"));
      }

      generateURL();
    }

    function generateURL() {
      const first = $("#firstSelect").val();
      const second = $("#secondSelect").val();
      const third = $("#thirdSelect").val();
      const forth = $("#forthSelect").val();

      const firstCode = codeMap[first] || "";
      const secondCode = codeMap[second] || "";
      const forthCode = codeMap[forth] || "";

      let url = "https://apis.data.go.kr/1543061/abandonmentPublicService_v2/abandonmentPublic_v2"
        + "?serviceKey=H18CHwE9DvQgtg5Gq0s4gyB%2B7jc7Qb2VHvbDRIQwxlYmxQL4dKuZVPMsOV1YapF8gGUjpodSnwMVD4qYNPslTA%3D%3D"
        + "&upr_cd=" + firstCode
        + "&org_cd=" + secondCode;

      // sex_cd는 'z'(모름)이 아니면 추가
      if (third && third !== "z") {
        url += "&sex_cd=" + codeMap[third];
      }
      url += "&upkind=" + forthCode + "&_type=json";

      generatedUrl = url;
    }

    function sendToServer() {
      if (!generatedUrl) {
        alert("세 항목 중 하나 이상을 선택해주세요.");
        return;
      }

      $.ajax({
        type: "GET",
        url: generatedUrl,
        success: function(response) {
          let html = "";
          try {
            // item이 배열일 수도 있고, 객체일 수도 있음
            let items = response?.response?.body?.items?.item;
            if (!items) {
              html = "데이터가 없습니다.";
            } else {
              // item이 배열이 아니면 배열로 변환
              if (!Array.isArray(items)) items = [items];
              items.forEach(function(item) {
                // 성별 변환
                let sex = "";
                if (item.sexCd === "F") sex = "여";
                else if (item.sexCd === "M") sex = "남";
                else sex = "모름";

                html += "<table border='1' style='margin-bottom:10px;'><tbody>";
                html += "<tr><td><img src='" + (item.popfile1 || "") + "' style='max-width:200px;'></td></tr>";
                html += "<tr><td>성별: " + sex + "</td></tr>";
                html += "<tr><td>" + (item.age || "") + "</td></tr>";
                html += "<tr><td>" + (item.careNm || "") + "</td></tr>";
                html += "<tr><td>" + (item.careTel || "") + "</td></tr>";
                html += "</tbody></table>";
              });
            }
          } catch (e) {
            html = "데이터 파싱 오류";
          }
          $("#result").html(html);
        },
        error: function(xhr, status, error) {
          console.error("에러 발생:", error);
          alert("전송 실패 (CORS 에러일 수 있음)");
        }
      });
    }
  </script>
</body>
</html>
